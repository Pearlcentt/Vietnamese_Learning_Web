<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${userDto != null and userDto.name != null} ? ${userDto.name} + ' - Profile' : 'Profile and Add Friend'">Profile and Add Friend</title>
    <link rel="stylesheet" th:href="@{/css/profile_add_friend.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Reset and Base Styles from dashboard theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
            Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        }

        :root {
            --PRIMARY_COLOR: #f5efe6;
            --ACTIVE_ITEM_COLOR: #da251d;
            --TITLE-text: #ff9e0c;
            --ITEM-text: #c75a00;
            --BORDER_LINE: #d9cfc0;
            --RIGHT-BOX: #5c5149;
            --duo-green: #58cc02;
            --duo-blue: #1cb0f6;
            --duo-gray-light: #e5e5e5;
            --duo-gray-medium: #afafaf;
            --duo-gray-dark: #777777;
            --duo-text-dark: #4b4b4b;
            --duo-text-light: #ffffff;
            --duo-border: #e5e5e5;
            --duo-yellow: #ffc800;
            --duo-red: #ff4b4b;
            --pearl-color: #f7b9d0;
            --light-green-button: #c8e6c9;
            --light-green-button-hover: #b9d8ba;
        }

        body {
            background-color: var(--PRIMARY_COLOR);
            color: var(--ITEM-text);
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .app-layout-container {
            display: flex;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Left Sidebar Styles (from dashboard) */
        .sidebar {
            width: 20%;
            background-color: var(--PRIMARY_COLOR);
            padding: 20px 0;
            border-right: 2px solid var(--BORDER_LINE);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            min-width: 220px;
        }

        .logo {
            padding: 0 20px;
            margin-bottom: 25px;
        }

        .logo h1 {
            color: var(--ITEM-text);
            font-size: 28px;
            font-weight: 700;
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #afafaf;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 16px;
            margin: 0 8px;
            text-decoration: none;
        }

        .nav-item:hover {
            background-color: var(--TITLE-text);
            color: #ffffff;
        }

        .nav-item.active {
            background-color: var(--TITLE-text);
            color: white;
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .nav-icon img {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }

        .home-icon {
            background-color: #e1d9c8;
            border-radius: 8px;
        }

        .nav-text {
            font-weight: 700;
            font-size: 15px;
        }
    </style>
</head>
<body>
<div class="app-layout-container">
    <!-- Left Sidebar (giống với leaderboard) -->
    <aside class="sidebar">
        <div class="logo">
            <h1>VietLingo</h1>
        </div>
        <nav class="nav-items">
            <!-- LEARN -->
            <a th:href="@{/dashboard}" class="nav-item">
                <div class="nav-icon home-icon">
                    <img th:src="@{/images/play-button.png}" alt="Learn" />
                </div>
                <span class="nav-text">LEARN</span>
            </a>

            <!-- LEADERBOARDS -->
            <a th:href="@{/leaderboard}" class="nav-item">
                <div class="nav-icon">
                    <img th:src="@{/images/businessman-with-target.png}" alt="Leaderboards" />
                </div>
                <span class="nav-text">LEADERBOARDS</span>
            </a>

            <!-- PROFILE (active) -->
            <a th:href="@{/profile_add_friend}" class="nav-item active">
                <div class="nav-icon">
                    <img th:src="@{/images/person.png}" alt="Profile" />
                </div>
                <span class="nav-text">PROFILE</span>
            </a>

            <!-- LOGOUT -->
            <a th:href="@{/logout}" class="nav-item" id="logoutLink">
                <div class="nav-icon">
                    <img th:src="@{/images/log_out.png}" alt="Logout" />
                </div>
                <span class="nav-text">LOGOUT</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content (Profile View & Edit View) -->
    <main class="main-profile-content">
        <div id="profileView" class="profile-view-active">
            <div class="profile-main">
                <div class="profile-header">
                    <div class="avatar-container">
                        <img src="/images/avatar3.png" alt="Avatar" id="profileAvatarDisplay" class="avatar-placeholder">
                    </div>
                </div>

                <div class="user-info">
                    <h1 id="displayName" th:text="${userDto?.name} ?: 'User Name'">User Name</h1>
                    <p class="username-joined">
                        <span id="username" th:text="${userDto?.username} ?: 'username123'">username123</span> -
                        Joined <span id="joinedDate" th:if="${userDto?.dateCreated != null}" th:text="${#temporals.format(userDto.dateCreated, 'MMMM yyyy')}">Unknown Date</span>
                        <span th:if="${userDto?.dateCreated == null}">Unknown Date</span>
                    </p>
                    <div class="follow-stats">
                        <a href="#" id="followingCountLink"><span id="followingCount" th:text="${userDto?.friends != null} ? ${userDto.friends.size()} : 0">0</span> Following</a>
                        <a href="#" id="followersCountLink"><span id="followersCount" th:text="${userDto?.friends != null} ? ${userDto.friends.size()} : 0">0</span> Followers</a>
                    </div>
                    <!-- Show edit button only for own profile -->
                    <button id="editProfileBtn" class="action-btn" th:if="${!viewOnly}"><i class="fas fa-user-edit"></i> Edit profile</button>
                    <!-- Show friend request actions for other users -->
                    <div th:if="${viewOnly}">
                        <button class="action-btn" th:if="${alreadyFriends}" disabled><i class="fas fa-users"></i> Friends</button>
                        <button class="action-btn" th:if="${requestSent}" disabled><i class="fas fa-check"></i> Request Sent</button>
                        <button class="action-btn" th:if="${requestReceived}" th:attr="data-requester-id=${userDto.uId}" id="acceptFriendBtn"><i class="fas fa-user-plus"></i> Accept</button>
                        <button class="action-btn" th:if="${requestReceived}" th:attr="data-requester-id=${userDto.uId}" id="declineFriendBtn"><i class="fas fa-user-times"></i> Decline</button>
                        <button class="action-btn" th:if="${!alreadyFriends and !requestSent and !requestReceived}" th:attr="data-target-id=${userDto.uId}" id="sendFriendRequestBtn"><i class="fas fa-user-plus"></i> Add Friend</button>
                    </div>
                </div>

                <div class="statistics-section">
                    <h2>Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <i class="fas fa-fire stat-icon"></i>
                            <p><strong id="dayStreak" th:text="${userDto?.streak} ?: 0">0</strong></p>
                            <p>Day streak</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-star stat-icon"></i>
                            <p><strong id="totalXP" th:text="${userDto?.gems} ?: 0">0</strong></p>
                            <p>Total Gems</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-shield-alt stat-icon"></i>
                            <p><strong id="currentLeague" th:text="${userDto?.currentLeague} ?: 'None'">None</strong></p>
                            <p>Current league</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-trophy stat-icon"></i>
                            <p><strong id="top3Finishes" th:text="${userDto?.top3Finishes} ?: 0">0</strong></p>
                            <p>Top 3 finishes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="editProfileView" class="edit-profile-container" style="display: none;">
            <h2><i class="fas fa-user-cog"></i> Edit profile</h2>
            <!-- Success Message -->
            <div th:if="${param.success}" class="alert alert-success">
                <i class="fas fa-check-circle"></i> Profile updated successfully!
            </div>
            <!-- Error Message -->
            <div th:if="${errorMessage}" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}">Error message</span>
            </div>
            <div th:if="${userEditForm != null}">
                <form id="editProfileForm" th:action="@{/profile/update}" method="post" th:object="${userEditForm}">
                    <div class="form-group">
                        <label for="editNameInput">Name</label>
                        <input type="text" id="editNameInput" th:field="*{displayName}">
                    </div>
                    <div class="form-group">
                        <label for="editUsernameInput">Username</label>
                        <input type="text" id="editUsernameInput" th:value="${userDto?.username} ?: ''" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editEmailInput">Email</label>
                        <input type="email" id="editEmailInput" th:field="*{email}">
                    </div>
                    <div class="form-group">
                        <label for="editCurrentPasswordInput">Current password</label>
                        <div class="password-wrapper">
                            <input type="password" id="editCurrentPasswordInput" th:field="*{currentPassword}">
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editNewPasswordInput">New password</label>
                        <div class="password-wrapper">
                            <input type="password" id="editNewPasswordInput" th:field="*{newPassword}">
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="saveProfileChangesBtn" class="action-btn primary">Save changes</button>
                        <button type="button" id="cancelEditProfileBtn" class="action-btn">Cancel</button>
                    </div>
                </form>
            </div>
            <div th:if="${userEditForm == null}" class="error-message">
                <p>Unable to load edit form. Please try again later.</p>
            </div>
        </div>
    </main>

    <!-- Sidebar Phải -->
    <aside class="profile-sidebar">
        <!-- Friend List -->
        <div class="friend-list-container card">
            <h3><i class="fas fa-users"></i> Friend List</h3>
            <ul id="friendListUi">
                <!-- Friend list items will be populated by JavaScript -->
            </ul>
            <p id="noFriendsMessage" class="empty-message" th:if="${userDto?.friends == null or userDto.friends.isEmpty()}">You have no friends. Let's connect with other people.</p>
        </div>

        <div class="add-friends-section card">
            <h3><i class="fas fa-user-plus"></i> Add Friends</h3>
            <div class="action-item" id="findFriendsToggle">
                <i class="fas fa-search"></i>
                <span>Find friends</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="findFriendsContent" class="collapsible-content">
                <input type="text" id="findFriendInput" placeholder="Enter name or username">
                <button id="searchFriendBtn"><i class="fas fa-search"></i> Find</button>
                <ul id="searchResultsUi"></ul>
            </div>

            <div class="action-item" id="friendRequestsToggle">
                <i class="fas fa-user-friends"></i>
                <span>Friend requests</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="friendRequestsContent" class="collapsible-content">
                <div class="friend-request-tabs">
                    <button class="fr-tab-btn active" data-tab="received">Received (<span id="receivedRequestCountBadge" th:text="${userDto?.receivedFriendRequests != null} ? ${userDto.receivedFriendRequests.size()} : 0">0</span>)</button>
                    <button class="fr-tab-btn" data-tab="sent">Sent (<span id="sentRequestCountBadge" th:text="${userDto?.sentFriendRequests != null} ? ${userDto.sentFriendRequests.size()} : 0">0</span>)</button>
                </div>
                <ul id="friendRequestsListUiReceived" class="friend-requests-list-display active">
                    <!-- Received friend requests will be populated by JavaScript -->
                </ul>
                <ul id="friendRequestsListUiSent" class="friend-requests-list-display" style="display:none;">
                    <!-- Sent friend requests will be populated by JavaScript -->
                </ul>
                <p id="noFriendRequestsMessage" class="empty-message" style="display: none;">No requests</p>
            </div>
        </div>
        <div class="sidebar-promo card">
            <img th:src="@{/images/promo_image.png}" alt="Promo image" class="promo-image">
            <p>Learning is more fun and effective when you connect with others.</p>
        </div>
    </aside>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    var serverData = {
        currentUser: /*[[${userDto}]]*/ null,
        csrfToken: /*[[${_csrf?.token}]]*/ '',
        csrfHeaderName: /*[[${_csrf?.headerName}]]*/ '',
        urls: {
            updateProfile: /*[[@{/api/profile/update}]]*/ '/api/profile/update',
            searchFriends: /*[[@{/friends/search}]]*/ '/friends/search',
            sendFriendRequest: /*[[@{/friends/request/send}]]*/ '/friends/request/send',
            acceptFriendRequest: /*[[@{/friends/request/accept}]]*/ '/friends/request/accept',
            declineFriendRequest: /*[[@{/friends/request/decline}]]*/ '/friends/request/decline',
            cancelFriendRequest: /*[[@{/friends/request/cancel}]]*/ '/friends/request/cancel',
            unfriend: /*[[@{/friends/unfriend}]]*/ '/friends/unfriend'
        }
    };

    // DEBUG: Log initial server data
    console.log('DEBUG: Initial serverData:', serverData);

    // Restructure friend data for JavaScript compatibility
    if (serverData.currentUser) {
        // Ensure friends array exists
        if (!serverData.currentUser.friends) {
            serverData.currentUser.friends = [];
        }

        // Structure friend requests data as expected by JavaScript
        serverData.currentUser.friendRequests = {
            received: serverData.currentUser.receivedFriendRequests || [],
            sent: serverData.currentUser.sentFriendRequests || []
        };

        // DEBUG: Log structured data
        console.log('DEBUG: Structured currentUser:', serverData.currentUser);
        console.log('DEBUG: Friends count:', serverData.currentUser.friends.length);
        console.log('DEBUG: Received requests count:', serverData.currentUser.friendRequests.received.length);
        console.log('DEBUG: Sent requests count:', serverData.currentUser.friendRequests.sent.length);
    }
    /*]]>*/
</script>
<script th:src="@{/js/profile_add_friend.js}"></script>

<!-- Script xác nhận logout giống như trong leaderboard -->
<script>
    const logoutLink = document.getElementById("logoutLink");
    if (logoutLink) {
        logoutLink.addEventListener("click", (event) => {
            event.preventDefault();
            if (confirm("Are you sure you want to logout?")) {
                window.location.href = logoutLink.href;
            }
        });
    }
</script>
</body>
</html>