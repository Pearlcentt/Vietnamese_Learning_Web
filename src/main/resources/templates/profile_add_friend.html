<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${userDto != null and userDto.name != null} ? ${userDto.name} + ' - Profile' : 'Profile and Add Friend'">Profile and Add Friend</title>
    <link rel="stylesheet" th:href="@{/css/profile_add_friend.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
<div class="app-layout-container">
    <!-- Left Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <h1>VietLingo</h1>
        </div>
        <nav class="nav-items">
            <a th:href="@{/dashboard}" class="nav-item">
                <div class="nav-icon home-icon">
                    <img th:src="@{/images/play-button.png}" alt="Learn" />
                </div>
                <span class="nav-text">LEARN</span>
            </a>
            <a th:href="@{/leaderboard}" class="nav-item">
                <div class="nav-icon">
                    <img th:src="@{/images/businessman-with-target.png}" alt="Leaderboards" />
                </div>
                <span class="nav-text">LEADERBOARDS</span>
            </a>
            <a th:href="@{/profile_add_friend}" class="nav-item active">
                <div class="nav-icon">
                    <img th:src="@{/images/person.png}" alt="Profile" />
                </div>
                <span class="nav-text">PROFILE</span>
            </a>
            <a th:href="@{/logout}" class="nav-item" id="logoutLink">
                <div class="nav-icon">
                    <img th:src="@{/images/log_out.png}" alt="Logout" />
                </div>
                <span class="nav-text">LOGOUT</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content (Profile View & Edit View) -->
    <main class="main-profile-content">
        <div id="profileView" class="profile-view-active">
            <div class="profile-main">                <div class="profile-header">
                    <div class="avatar-container">
                        <img th:src="${userDto?.avatar != null ? userDto.avatar : '/images/default_avatar.png'}" alt="Avatar" id="profileAvatarDisplay" class="avatar-placeholder">
                    </div>
                </div>

                <div class="user-info">
                    <h1 id="displayName" th:text="${userDto?.name} ?: 'User Name'">User Name</h1>
                    <p class="username-joined">
                        <span id="username" th:text="${userDto?.username} ?: 'username123'">username123</span> -
                        Joined <span id="joinedDate" th:if="${userDto?.dateCreated != null}" th:text="${#temporals.format(userDto.dateCreated, 'MMMM yyyy')}">Unknown Date</span>
                        <span th:if="${userDto?.dateCreated == null}">Unknown Date</span>
                    </p>
                    <div class="follow-stats">
                        <a href="#" id="followingCountLink"><span id="followingCount" th:text="${userDto?.friends != null} ? ${userDto.friends.size()} : 0">0</span> Following</a>
                        <a href="#" id="followersCountLink"><span id="followersCount" th:text="${userDto?.friends != null} ? ${userDto.friends.size()} : 0">0</span> Followers</a>
                    </div>
                    <!-- Show edit button only for own profile -->
                    <button id="editProfileBtn" class="action-btn" th:if="${!viewOnly}"><i class="fas fa-user-edit"></i> Edit profile</button>
                    <!-- Show friend request actions for other users -->
                    <div th:if="${viewOnly}">
                        <button class="action-btn" th:if="${alreadyFriends}" disabled><i class="fas fa-users"></i> Friends</button>
                        <button class="action-btn" th:if="${requestSent}" disabled><i class="fas fa-check"></i> Request Sent</button>
                        <button class="action-btn" th:if="${requestReceived}" th:attr="data-requester-id=${userDto.uId}" id="acceptFriendBtn"><i class="fas fa-user-plus"></i> Accept</button>
                        <button class="action-btn" th:if="${requestReceived}" th:attr="data-requester-id=${userDto.uId}" id="declineFriendBtn"><i class="fas fa-user-times"></i> Decline</button>
                        <button class="action-btn" th:if="${!alreadyFriends and !requestSent and !requestReceived}" th:attr="data-target-id=${userDto.uId}" id="sendFriendRequestBtn"><i class="fas fa-user-plus"></i> Add Friend</button>
                    </div>
                </div>

                <div class="statistics-section">
                    <h2>Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <i class="fas fa-fire stat-icon"></i>
                            <p><strong id="dayStreak" th:text="${userDto?.streak} ?: 0">0</strong></p>
                            <p>Day streak</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-star stat-icon"></i>
                            <p><strong id="totalXP" th:text="${userDto?.gems} ?: 0">0</strong></p>
                            <p>Total Gems</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-shield-alt stat-icon"></i>
                            <p><strong id="currentLeague" th:text="${userDto?.currentLeague} ?: 'None'">None</strong></p>
                            <p>Current league</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-trophy stat-icon"></i>
                            <p><strong id="top3Finishes" th:text="${userDto?.top3Finishes} ?: 0">0</strong></p>
                            <p>Top 3 finishes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>        <div id="editProfileView" class="edit-profile-container" style="display: none;">
            <h2><i class="fas fa-user-cog"></i> Edit profile</h2>
            
            <!-- Success Message -->
            <div th:if="${param.success}" class="alert alert-success">
                <i class="fas fa-check-circle"></i> Profile updated successfully!
            </div>
            
            <!-- Error Message -->
            <div th:if="${errorMessage}" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}">Error message</span>
            </div>
            
            <div th:if="${userEditForm != null}">
                <form id="editProfileForm" th:action="@{/profile/update}" method="post" th:object="${userEditForm}">
                    <div class="form-group">
                        <label for="editNameInput">Name</label>
                        <input type="text" id="editNameInput" th:field="*{displayName}">
                    </div>
                    <div class="form-group">
                        <label for="editUsernameInput">Username</label>
                        <input type="text" id="editUsernameInput" th:value="${userDto?.username} ?: ''" readonly>
                    </div>                    <div class="form-group">
                        <label for="editEmailInput">Email</label>
                        <input type="email" id="editEmailInput" th:field="*{email}">
                    </div>
                    <div class="form-group">
                        <label for="editAvatarInput">Avatar URL</label>
                        <input type="url" id="editAvatarInput" th:field="*{avatar}" placeholder="Enter avatar image URL">
                        <small class="form-text">Enter a valid image URL for your profile picture</small>
                    </div>
                    <div class="form-group">
                        <label for="editCurrentPasswordInput">Current password</label>
                        <div class="password-wrapper">
                            <input type="password" id="editCurrentPasswordInput" th:field="*{currentPassword}">
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editNewPasswordInput">New password</label>
                        <div class="password-wrapper">
                            <input type="password" id="editNewPasswordInput" th:field="*{newPassword}">
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="saveProfileChangesBtn" class="action-btn primary">Save changes</button>
                        <button type="button" id="cancelEditProfileBtn" class="action-btn">Cancel</button>
                    </div>
                </form>
            </div>
            <div th:if="${userEditForm == null}" class="error-message">
                <p>Unable to load edit form. Please try again later.</p>
            </div>
        </div>
    </main>

    <!-- Sidebar Pháº£i -->
    <aside class="profile-sidebar">
        <!-- Friend List -->
        <div class="friend-list-container card">
            <h3><i class="fas fa-users"></i> Friend List</h3>
            <ul id="friendListUi">
                <!-- Friend list items will be populated by JavaScript -->
            </ul>
            <p id="noFriendsMessage" class="empty-message" th:if="${userDto?.friends == null or userDto.friends.isEmpty()}">You have no friends. Let's connect with other people.</p>
        </div>

        <div class="add-friends-section card">
            <h3><i class="fas fa-user-plus"></i> Add Friends</h3>
            <div class="action-item" id="findFriendsToggle">
                <i class="fas fa-search"></i>
                <span>Find friends</span>
                <i class="fas fa-chevron-right"></i>
            </div>            <div id="findFriendsContent" class="collapsible-content">
                <input type="text" id="findFriendInput" placeholder="Enter username">
                <button id="searchFriendBtn"><i class="fas fa-search"></i> Find</button>
                <ul id="searchResultsUi"></ul>
            </div>

            <div class="action-item" id="friendRequestsToggle">
                <i class="fas fa-user-friends"></i>
                <span>Friend requests</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="friendRequestsContent" class="collapsible-content">
                <div class="friend-request-tabs">
                    <button class="fr-tab-btn active" data-tab="received">Received (<span id="receivedRequestCountBadge" th:text="${userDto?.receivedFriendRequests != null} ? ${userDto.receivedFriendRequests.size()} : 0">0</span>)</button>
                    <button class="fr-tab-btn" data-tab="sent">Sent (<span id="sentRequestCountBadge" th:text="${userDto?.sentFriendRequests != null} ? ${userDto.sentFriendRequests.size()} : 0">0</span>)</button>
                </div>
                <ul id="friendRequestsListUiReceived" class="friend-requests-list-display active">
                    <!-- Received friend requests will be populated by JavaScript -->
                </ul>
                <ul id="friendRequestsListUiSent" class="friend-requests-list-display" style="display:none;">
                    <!-- Sent friend requests will be populated by JavaScript -->
                </ul>
                <p id="noFriendRequestsMessage" class="empty-message" style="display: none;">No requests</p>
            </div>
        </div>
        <div class="sidebar-promo card">
            <img th:src="@{/images/promo_image.png}" alt="Promo image" class="promo-image">
            <p>Learning is more fun and effective when you connect with others.</p>
        </div>
    </aside>
</div>

<script th:inline="javascript">    /*<![CDATA[*/
    window.serverData = {
        currentUser: /*[[${userDto}]]*/ null,
        csrfToken: /*[[${_csrf?.token}]]*/ '',
        csrfHeaderName: /*[[${_csrf?.headerName}]]*/ '',        
        urls: {
            updateProfile: /*[[@{/api/profile/update}]]*/ '/api/profile/update',
            searchFriends: /*[[@{/friends/search}]]*/ '/friends/search',
            sendFriendRequest: /*[[@{/friends/request/send}]]*/ '/friends/request/send',
            acceptFriendRequest: /*[[@{/friends/request/accept}]]*/ '/friends/request/accept',
            declineFriendRequest: /*[[@{/friends/request/decline}]]*/ '/friends/request/decline',
            cancelFriendRequest: /*[[@{/friends/request/cancel}]]*/ '/friends/request/cancel',
            unfriend: /*[[@{/friends/unfriend}]]*/ '/friends/unfriend'
        },
        sampleAvatars: [
            '/images/avatar1.png',
            '/images/avatar2.png',
            '/images/avatar3.png',
            '/images/avatar4.png',
            '/images/avatar5.png',
            '/images/avatar6.png',
            '/images/avatar7.png'
        ],
        defaultAvatarUrl: '/images/default_avatar.png'
    };
    
    // Restructure friend data for JavaScript compatibility
    if (window.serverData.currentUser) {
        // Ensure friends array exists
        if (!window.serverData.currentUser.friends) {
            window.serverData.currentUser.friends = [];
        }
        
        // Structure friend requests data as expected by JavaScript
        window.serverData.currentUser.friendRequests = {
            received: window.serverData.currentUser.receivedFriendRequests || [],
            sent: window.serverData.currentUser.sentFriendRequests || []
        };
    }
    /*]]>*/
</script>
<script th:src="@{/js/profile_add_friend.js}"></script>
</body>
</html>