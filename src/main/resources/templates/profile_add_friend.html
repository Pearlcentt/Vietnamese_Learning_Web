<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${userDto != null and userDto.name != null} ? ${userDto.name} + ' - Profile' : 'Profile and Add Friend'">Profile and Add Friend</title>
    <link rel="stylesheet" th:href="@{/css/profile_add_friend.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
<div class="app-layout-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1>VietLingo</h1>
        </div>
        <div class="nav-items">
            <a th:href="@{/dashboard}" class="nav-item"
               th:classappend="${#request.requestURI == '/dashboard' ? 'active' : ''}">
                <div class="nav-icon home-icon">
                    <img th:src="@{/images/play-button.png}" alt="Learn Icon" />
                </div>
                <span class="nav-text">LEARN</span>
            </a>
            <a th:href="@{/leaderboard}" class="nav-item"
               th:classappend="${#request.requestURI == '/leaderboard' ? 'active' : ''}">
                <div class="nav-icon">
                    <img th:src="@{/images/businessman-with-target.png}" alt="Leaderboards Icon" />
                </div>
                <span class="nav-text">LEADERBOARDS</span>
            </a>
            <a th:href="@{/profile}" class="nav-item"
               th:classappend="${#strings.startsWith(#request.requestURI, '/profile') ? 'active' : ''}">
                <div class="nav-icon">
                    <img th:src="@{/images/person.png}" alt="Profile Icon" />
                </div>
                <span class="nav-text">PROFILE</span>
            </a>
            <form th:action="@{/logout}" method="post" class="nav-item-form">
                <button type="submit" class="nav-item nav-item-logout-btn" id="logoutButton">
                    <div class="nav-icon logout-icon">
                        <img th:src="@{/images/log_out.png}" alt="Logout Icon" />
                    </div>
                    <span class="nav-text">LOGOUT</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-profile-content">
        <div id="profileView" class="profile-view-active">
            <div class="profile-main">
                <div class="profile-header">
                    <div class="avatar-container">
                        <!-- SỬA Ở ĐÂY: userDto.avatar -->
                        <img th:src="${userDto?.avatar ?: '/images/default-avatar.svg'}" alt="Avatar" id="profileAvatarDisplay" class="avatar-placeholder">
                    </div>
                </div>
                <div class="user-info">
                    <h1 id="displayName" th:text="${userDto?.name} ?: 'User Name'">User Name</h1>
                    <p class="username-joined">
                        <span id="username" th:text="${userDto?.username} ?: 'username123'">username123</span> -
                        Joined <span id="joinedDate" th:if="${userDto?.dateCreated != null}" th:text="${#temporals.format(userDto.dateCreated, 'MMMM yyyy')}">Unknown Date</span>
                        <span th:if="${userDto?.dateCreated == null}">Unknown Date</span>
                    </p>
                    <div class="follow-stats">
                        <a href="#" id="followingCountLink"><span id="followingCount" th:text="${userDto?.friends != null} ? ${#lists.size(userDto.friends)} : 0">0</span> Following</a>
                        <a href="#" id="followersCountLink"><span id="followersCount" th:text="${userDto?.friends != null} ? ${#lists.size(userDto.friends)} : 0">0</span> Followers</a>
                    </div>
                    <button id="editProfileBtn" class="action-btn" th:if="${!viewOnly}"><i class="fas fa-user-edit"></i> Edit profile</button>
                    <div th:if="${viewOnly}">
                        <button class="action-btn" th:if="${alreadyFriends}" disabled><i class="fas fa-users"></i> Friends</button>
                        <button class="action-btn" th:if="${requestSent}" disabled><i class="fas fa-check"></i> Request Sent</button>
                        <button class="action-btn" th:if="${requestReceived}" th:attr="data-requester-id=${userDto.uId}" id="acceptFriendBtn"><i class="fas fa-user-plus"></i> Accept</button>
                        <button class="action-btn" th:if="${requestReceived}" th:attr="data-requester-id=${userDto.uId}" id="declineFriendBtn"><i class="fas fa-user-times"></i> Decline</button>
                        <button class="action-btn" th:if="${!alreadyFriends and !requestSent and !requestReceived}" th:attr="data-target-id=${userDto.uId}" id="sendFriendRequestBtn"><i class="fas fa-user-plus"></i> Add Friend</button>
                    </div>
                </div>
                <div class="statistics-section">
                    <h2>Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <i class="fas fa-fire stat-icon"></i>
                            <p><strong id="dayStreak" th:text="${userDto?.streak} ?: 0">0</strong></p>
                            <p>Day streak</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-star stat-icon"></i>
                            <p><strong id="totalXP" th:text="${userDto?.gems} ?: 0">0</strong></p> <!-- ID là totalXP nhưng hiển thị gems -->
                            <p>Total Gems</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-shield-alt stat-icon"></i>
                            <p><strong id="currentLeague" th:text="${userDto?.currentLeague} ?: 'None'">None</strong></p>
                            <p>Current league</p>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-trophy stat-icon"></i>
                            <p><strong id="top3Finishes" th:text="${userDto?.top3Finishes} ?: 0">0</strong></p>
                            <p>Top 3 finishes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="editProfileView" class="edit-profile-container" style="display: none;">
            <h2><i class="fas fa-user-cog"></i> Edit profile</h2>
            <div th:if="${param.success}" class="alert alert-success">
                <i class="fas fa-check-circle"></i> Profile updated successfully!
            </div>
            <div th:if="${errorMessage}" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}">Error message</span>
            </div>
            <div th:if="${userEditForm != null}">
                <form id="editProfileForm" th:action="@{/profile/update}" method="post" th:object="${userEditForm}">
                    <div class="form-group avatar-edit-group">
                        <!-- SỬA Ở ĐÂY: userEditForm.avatar (giả sử UserEditForm cũng dùng 'avatar') hoặc userDto.avatar -->
                        <img th:src="${userEditForm?.avatar ?: (userDto?.avatar ?: '/images/default-avatar.svg')}" alt="Current Avatar" id="editAvatarPreview" class="avatar-preview">
                        <!-- SỬA Ở ĐÂY: th:field="*{avatar}" (nếu UserEditForm có trường 'avatar') -->
                        <input type="hidden" id="selectedAvatarUrlInput" th:field="*{avatar}"> <!-- Giả sử UserEditForm có trường 'avatar' -->
                        <div>
                            <button type="button" id="openAvatarModalBtnEdit" class="action-btn"><i class="fas fa-image"></i> Change Avatar</button>
                            <p class="avatar-note">Select a new avatar or upload your own.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editNameInput">Name</label>
                        <input type="text" id="editNameInput" th:field="*{displayName}"> <!-- Giả sử UserEditForm có trường 'displayName' -->
                    </div>
                    <div class="form-group">
                        <label for="editUsernameInput">Username</label>
                        <input type="text" id="editUsernameInput" th:value="${userDto?.username} ?: ''" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editEmailInput">Email</label>
                        <input type="email" id="editEmailInput" th:field="*{email}">
                    </div>
                    <div class="form-group">
                        <label for="editCurrentPasswordInput">Current password (leave blank to keep current)</label>
                        <div class="password-wrapper">
                            <input type="password" id="editCurrentPasswordInput" th:field="*{currentPassword}">
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editNewPasswordInput">New password (leave blank to keep current)</label>
                        <div class="password-wrapper">
                            <input type="password" id="editNewPasswordInput" th:field="*{newPassword}">
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="saveProfileChangesBtn" class="action-btn primary">Save changes</button>
                        <button type="button" id="cancelEditProfileBtn" class="action-btn">Cancel</button>
                    </div>
                </form>
            </div>
            <div th:if="${userEditForm == null}" class="error-message">
                <p>Unable to load edit form. Please try again later.</p>
            </div>
        </div>
    </main>

    <!-- Sidebar Phải -->
    <aside class="profile-sidebar">
        <div class="friend-list-container card">
            <h3><i class="fas fa-users"></i> Friend List</h3>
            <ul id="friendListUi"></ul>
            <p id="noFriendsMessage" class="empty-message" th:if="${userDto?.friends == null or #lists.isEmpty(userDto.friends)}">You have no friends. Let's connect with other people.</p>
        </div>
        <div class="add-friends-section card">
            <h3><i class="fas fa-user-plus"></i> Add Friends</h3>
            <div class="action-item" id="findFriendsToggle">
                <i class="fas fa-search"></i>
                <span>Find friends</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="findFriendsContent" class="collapsible-content">
                <input type="text" id="findFriendInput" placeholder="Enter name or username">
                <button id="searchFriendBtn"><i class="fas fa-search"></i> Find</button>
                <ul id="searchResultsUi"></ul>
            </div>
            <div class="action-item" id="friendRequestsToggle">
                <i class="fas fa-user-friends"></i>
                <span>Friend requests</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="friendRequestsContent" class="collapsible-content">
                <div class="friend-request-tabs">
                    <button class="fr-tab-btn active" data-tab="received">Received (<span id="receivedRequestCountBadge" th:text="${userDto?.receivedFriendRequests != null} ? ${#lists.size(userDto.receivedFriendRequests)} : 0">0</span>)</button>
                    <button class="fr-tab-btn" data-tab="sent">Sent (<span id="sentRequestCountBadge" th:text="${userDto?.sentFriendRequests != null} ? ${#lists.size(userDto.sentFriendRequests)} : 0">0</span>)</button>
                </div>
                <ul id="friendRequestsListUiReceived" class="friend-requests-list-display active"></ul>
                <ul id="friendRequestsListUiSent" class="friend-requests-list-display" style="display:none;"></ul>
                <p id="noFriendRequestsMessage" class="empty-message" style="display: none;">No requests</p>
            </div>
        </div>
        <div class="sidebar-promo card">
            <img th:src="@{/images/promo_image.png}" alt="Promo image" class="promo-image">
            <p>Learning is more fun and effective when you connect with others.</p>
        </div>
    </aside>
</div>

<!-- Avatar Modal -->
<div id="avatarModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" id="closeAvatarModalBtn">×</span>
        <h3>Choose Your Avatar</h3>
        <div class="avatar-selection-grid" id="avatarSelectionGrid"></div>
        <p>Or <label for="avatarUpload" class="upload-link">upload your own image</label>.</p>
        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
        <button id="confirmAvatarSelectionBtn" class="action-btn primary">Confirm Selection</button>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    var serverData = {
        currentUser: /*[[${userDto}]]*/ null, // userDto có trường 'avatar', 'name', 'dateCreated'
        viewOnly: /*[[${viewOnly}]]*/ false,
        alreadyFriends: /*[[${alreadyFriends}]]*/ false,
        requestSent: /*[[${requestSent}]]*/ false,
        requestReceived: /*[[${requestReceived}]]*/ false,
        userEditForm: /*[[${userEditForm}]]*/ null, // Giả sử UserEditForm cũng có trường 'avatar'
        errorMessage: /*[[${errorMessage}]]*/ null,
        sampleAvatars: /*[[${sampleAvatars ?: T(java.util.Arrays).asList('/images/av1.png', '/images/av2.png')}]]*/ [],
        defaultAvatarUrl: /*[[@{/images/default-avatar.svg}]]*/ '/images/default-avatar.svg', // Đây là URL mặc định
        csrfToken: /*[[${_csrf?.token}]]*/ '',
        csrfHeaderName: /*[[${_csrf?.headerName}]]*/ '',
        urls: {
            updateProfile: /*[[@{/profile/update}]]*/ '/profile/update',
            uploadAvatar: /*[[@{/profile/avatar/upload}]]*/ '/profile/avatar/upload',
            searchFriends: /*[[@{/friends/search}]]*/ '/friends/search',
            sendFriendRequest: /*[[@{/friends/request/send}]]*/ '/friends/request/send',
            acceptFriendRequest: /*[[@{/friends/request/accept}]]*/ '/friends/request/accept',
            declineFriendRequest: /*[[@{/friends/request/decline}]]*/ '/friends/request/decline',
            cancelFriendRequest: /*[[@{/friends/request/cancel}]]*/ '/friends/request/cancel',
            unfriend: /*[[@{/friends/unfriend}]]*/ '/friends/unfriend'
        }
    };

    if (serverData.currentUser) {
        if (!serverData.currentUser.friends) {
            serverData.currentUser.friends = [];
        }
        // Đã có receivedFriendRequests và sentFriendRequests trong DTO
        serverData.currentUser.friendRequests = {
            received: serverData.currentUser.receivedFriendRequests || [],
            sent: serverData.currentUser.sentFriendRequests || []
        };
    }
    /*]]>*/
</script>
<script th:src="@{/js/profile_add_friend.js}"></script>
</body>
</html>